name: Release

on:
  # Manual trigger with version input
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v0.0.10)'
        required: true
        type: string

  # PR comment trigger for fast-forward merge
  issue_comment:
    types: [created, edited]

jobs:
  # Create release and PR (triggered manually)
  create-release:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout master
        uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create tag
        run: |
          git tag -a ${{ inputs.version }} -m "Release ${{ inputs.version }}"
          git push origin ${{ inputs.version }}

      - name: Create prerelease
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ inputs.version }} \
            --title "${{ inputs.version }}" \
            --generate-notes \
            --prerelease

      - name: Create PR to production
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --base production \
            --head master \
            --title "Release ${{ inputs.version }}" \
            --body "## Release ${{ inputs.version }}

          This PR releases ${{ inputs.version }} to production.

          Comment \`/release\` to fast-forward merge and publish."

  # Fast-forward merge and publish (triggered by /release comment)
  publish-release:
    if: ${{ github.event_name == 'issue_comment' 
            && contains(github.event.comment.body, '/release')
            && github.event.issue.pull_request }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Check PR is open
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            if (pr.data.state !== 'open') {
              core.setFailed('PR is not open');
            }

      - name: React to comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fast forward merge
        uses: sequoia-pgp/fast-forward@v1
        with:
          merge: true
          comment: always

      - name: Publish prerelease as latest
        uses: actions/github-script@v7
        with:
          script: |
            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 10
            });
            
            const prerelease = releases.data.find(r => r.prerelease);
            if (!prerelease) {
              console.log('No prerelease found');
              return;
            }
            
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: prerelease.id,
              prerelease: false,
              make_latest: 'true'
            });
            
            console.log(`Published: ${prerelease.tag_name}`);

      - name: Comment success
        uses: actions/github-script@v7
        with:
          script: |
            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 1
            });
            
            const release = releases.data[0];
            const message = release && !release.prerelease
              ? `ðŸš€ Released [${release.tag_name}](${release.html_url})`
              : 'âœ… Fast-forward merge complete!';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });
