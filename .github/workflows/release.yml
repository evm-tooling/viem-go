name: Release

on:
  issue_comment:
    types: [created, edited]

jobs:
  release:
    # Only run if the comment contains /release on a PR
    if: ${{ contains(github.event.comment.body, '/release')
            && github.event.issue.pull_request }}
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Check PR is open
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            if (pr.data.state !== 'open') {
              core.setFailed('PR is not open');
              return;
            }

      - name: React to comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fast forward merge
        uses: sequoia-pgp/fast-forward@v1
        with:
          merge: true
          comment: always

      - name: Publish prerelease as latest
        uses: actions/github-script@v7
        with:
          script: |
            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 10
            });
            
            // Find the latest prerelease
            const prerelease = releases.data.find(r => r.prerelease);
            
            if (!prerelease) {
              console.log('No prerelease found, skipping publish');
              return;
            }
            
            // Publish it as the latest release
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: prerelease.id,
              prerelease: false,
              make_latest: 'true'
            });
            
            core.setOutput('tag', prerelease.tag_name);
            core.setOutput('url', prerelease.html_url);
            console.log(`Published release: ${prerelease.tag_name}`);

      - name: Comment success
        uses: actions/github-script@v7
        with:
          script: |
            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 1
            });
            
            const release = releases.data[0];
            const message = release && !release.prerelease
              ? `ðŸš€ Released [${release.tag_name}](${release.html_url})`
              : 'âœ… Fast-forward merge complete!';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });
