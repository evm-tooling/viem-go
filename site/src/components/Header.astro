---
import type { Props } from '@astrojs/starlight/props';
import Search from '@astrojs/starlight/components/Search.astro';
import SiteTitle from '@astrojs/starlight/components/SiteTitle.astro';

// Fetch latest version from GitHub releases at build time
let version = "v0.1.0"; // fallback
try {
  const response = await fetch(
    'https://api.github.com/repos/ChefBingbong/viem-go/releases/latest',
    { headers: { 'Accept': 'application/vnd.github.v3+json' } }
  );
  if (response.ok) {
    const release = await response.json();
    version = release.tag_name || version;
  }
} catch (e) {
  // Use fallback version on error
}
---

<div class="header sl-flex">
  <div class="header-left">
    <SiteTitle {...Astro.props} />
    <div class="search-wrapper">
      <Search {...Astro.props} />
    </div>
  </div>
  <div class="header-right">
    <a href="/introduction/" class="nav-link">Docs</a>
    <a href="https://github.com/ChefBingbong/viem-go" class="nav-link" target="_blank" rel="noopener">GitHub</a>
    <div class="version-dropdown">
      <button class="version-trigger" aria-expanded="false" aria-haspopup="true">
        {version}
        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="chevron">
          <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
      </button>
      <div class="version-menu">
        <a href="https://github.com/ChefBingbong/viem-go/releases" class="version-item" target="_blank" rel="noopener">
          Releases
          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="external-icon"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
        </a>
        <a href="https://github.com/ChefBingbong/viem-go/blob/main/.github/CONTRIBUTING.md" class="version-item" target="_blank" rel="noopener">
          Contributing
          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="external-icon"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
        </a>
        <a href="https://github.com/ChefBingbong/viem-go/tree/main/examples" class="version-item" target="_blank" rel="noopener">
          Examples
          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="external-icon"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
        </a>
      </div>
    </div>
  </div>
</div>

<script is:inline>
  function initVersionDropdown() {
    const dropdown = document.querySelector('.version-dropdown');
    const trigger = dropdown?.querySelector('.version-trigger');
    const menu = dropdown?.querySelector('.version-menu');

    if (!trigger || !menu) return;

    // Remove existing listeners by cloning
    const newTrigger = trigger.cloneNode(true);
    trigger.parentNode.replaceChild(newTrigger, trigger);

    // Toggle dropdown on click
    newTrigger.addEventListener('click', (e) => {
      e.stopPropagation();
      const isOpen = newTrigger.getAttribute('aria-expanded') === 'true';
      newTrigger.setAttribute('aria-expanded', (!isOpen).toString());
      menu.classList.toggle('open', !isOpen);
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', () => {
      newTrigger.setAttribute('aria-expanded', 'false');
      menu.classList.remove('open');
    });

    // Prevent menu clicks from closing dropdown immediately
    menu.addEventListener('click', (e) => {
      e.stopPropagation();
    });
  }

  // Run on initial load
  initVersionDropdown();

  // Run on Astro page transitions
  document.addEventListener('astro:page-load', initVersionDropdown);
</script>

<style>
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    gap: 1rem;
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: 1.25rem;

  }

  .search-wrapper {
    min-width: 300px;
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .nav-link {
    color: var(--sl-color-gray-2);
    text-decoration: none;
    font-weight: 500;
    font-size: 1rem;
    padding: 0.5rem 0.75rem;
    border-radius: 0.375rem;
    transition: color 0.2s ease, background 0.2s ease;
  }

  .nav-link:hover {
    color: var(--sl-color-white);
    background: rgba(255, 255, 255, 0.05);
  }

  /* Version dropdown */
  .version-dropdown {
    position: relative;
  }

  .version-trigger {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    color: var(--sl-color-gray-2);
    background: transparent;
    border: 1px solid var(--sl-color-gray-5);
    font-weight: 500;
    font-size: 1rem;
    padding: 0.375rem 0.75rem;
    border-radius: 0.375rem;
    cursor: pointer;
    transition: color 0.2s ease, background 0.2s ease, border-color 0.2s ease;
  }

  .version-trigger:hover {
    color: var(--sl-color-white);
    background: rgba(255, 255, 255, 0.05);
    border-color: var(--sl-color-gray-4);
  }

  .version-trigger .chevron {
    transition: transform 0.2s ease;
  }

  .version-trigger[aria-expanded="true"] .chevron {
    transform: rotate(180deg);
  }

  .version-menu {
    position: absolute;
    top: calc(100% + 0.5rem);
    right: 0;
    min-width: 160px;
    background: var(--sl-color-gray-6);
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.5rem;
    padding: 0.375rem;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-0.25rem);
    transition: opacity 0.15s ease, transform 0.15s ease, visibility 0.15s ease;
    z-index: 100;
  }

  .version-menu.open,
  .version-dropdown:hover .version-menu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .version-dropdown:hover .version-trigger .chevron {
    transform: rotate(180deg);
  }

  .version-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
    color: var(--sl-color-gray-2);
    text-decoration: none;
    font-size: 0.875rem;
    padding: 0.5rem 0.75rem;
    border-radius: 0.25rem;
    transition: color 0.15s ease, background 0.15s ease;
  }

  .version-item:hover {
    color: var(--sl-color-white);
    background: rgba(255, 255, 255, 0.08);
  }

  .version-item .external-icon {
    opacity: 0.5;
    flex-shrink: 0;
  }

  .version-item:hover .external-icon {
    opacity: 0.8;
  }

  /* Logo sizing */
  .header-left :global(.site-title img) {
    height: 2.25rem !important;
    width: auto !important;
  }

  @media (max-width: 768px) {
    .header-left {
      gap: 0.75rem;
    }

    .search-wrapper {
      min-width: 120px;
    }

    .nav-link {
      padding: 0.375rem 0.5rem;
      font-size: 0.9375rem;
    }

    .version-trigger {
      font-size: 0.9375rem;
    }
  }

  @media (max-width: 480px) {
    .nav-link {
      display: none;
    }

    .version-trigger {
      padding: 0.25rem 0.5rem;
      font-size: 0.875rem;
    }

    .version-menu {
      right: -1rem;
    }
  }
</style>
